#!/usr/bin/env bash

set -euo pipefail

arch-chroot "$BOOTSTRAP_MOUNT_DIR" groupadd -f "$BOOTSTRAP_ADMIN_GROUP"

export ADMIN_GROUP=$BOOTSTRAP_ADMIN_GROUP

if [[ -v BOOTSTRAP_ADMIN_GROUP_NOPASSWD ]]; then
    template-install /etc/sudoers.d/49-admin{-nopasswd,}
    template-install /etc/polkit-1/rules.d/49-admin{-nopasswd,}.rules
else
    template-install /etc/sudoers.d/49-admin
fi

arch-chroot "$BOOTSTRAP_MOUNT_DIR" useradd --create-home --groups users,"$BOOTSTRAP_ADMIN_GROUP" "$BOOTSTRAP_ADMIN_LOGIN"
printf "%s:%s" "$BOOTSTRAP_ADMIN_LOGIN" "$BOOTSTRAP_ADMIN_PASSWORD" | chpasswd -R "$BOOTSTRAP_MOUNT_DIR"

if [[ -v BOOTSTRAP_ADMIN_USE_SSH_AUTHORIZED_KEYS ]]; then
    rsync -va ~/.ssh/authorized_keys "$BOOTSTRAP_MOUNT_DIR"/home/"$BOOTSTRAP_ADMIN_LOGIN"/.ssh/
    arch-chroot "$BOOTSTRAP_MOUNT_DIR" chown -R "$BOOTSTRAP_ADMIN_LOGIN:$BOOTSTRAP_ADMIN_LOGIN" /home/"$BOOTSTRAP_ADMIN_LOGIN"/.ssh
fi

arch-chroot "$BOOTSTRAP_MOUNT_DIR" passwd --lock root
