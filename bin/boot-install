#!/usr/bin/env bash

set -euo pipefail

preload_modules=(part_gpt lvm)

if [[ $INSTALL_BOOT_FIRMWARE == uefi ]]; then
    preload_modules+=(part_msdos)
fi

cmdline_linux_default=(quiet loglevel="$INSTALL_LOGLEVEL" consoleblank="$INSTALL_CONSOLEBLANK")
cmdline_linux=(resume="$INSTALL_SWAP_DEVICE")

if ((INSTALL_DEVICE_IS_LUKS)); then
    export GRUB_ENABLE_CRYPTODISK=y
    preload_modules+=(cryptodisk luks)
    cmdline_linux+=(cryptkey=rootfs:"$INSTALL_LUKS_ROOT_KEYFILE")
    cryptdevice=UUID=$(blkid -s UUID -o value "$INSTALL_LUKS_DEVICE"):$INSTALL_LUKS_MAPPER_NAME
    if ((INSTALL_DEVICE_IS_SSD)); then
        cryptdevice+=':allow-discards'
    fi
    cmdline_linux+=(cryptdevice="$cryptdevice")
else
    export GRUB_ENABLE_CRYPTODISK=n
fi

export GRUB_PRELOAD_MODULES=${preload_modules[*]}
export GRUB_CMDLINE_LINUX=${cmdline_linux[*]}
export GRUB_CMDLINE_LINUX_DEFAULT=${cmdline_linux_default[*]}
template-install /etc/default/grub

arch-chroot "$INSTALL_MOUNT" grub-install "$INSTALL_DEVICE" --recheck
arch-chroot "$INSTALL_MOUNT" grub-mkconfig --output=/boot/grub/grub.cfg
