#!/usr/bin/env bash

set -euo pipefail

# Apply file system modifications, backing up original files.
rsync -rlv -b --suffix=.pacnew ./rootfs/ /mnt

# Persist any WIFI connections.
rsync -av --no-owner --no-group /var/lib/iwd/ /mnt/var/lib/iwd

# Use the systemd generated resolv.conf.
ln -sfv /run/systemd/resolve/stub-resolv.conf /mnt/etc/resolv.conf

# Ensure a machine id is generated on the first boot.
rm /mnt/etc/machine-id

export REFLECTOR_COUNTRY=$INSTALL_COUNTRY
template-install ./templates/etc/xdg/reflector/reflector.conf

arch-chroot /mnt /install.sh
rm /mnt/install.sh
