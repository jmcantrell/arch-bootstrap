#!/usr/bin/env bash

set -euo pipefail

genfstab -t UUID "$BOOTSTRAP_MOUNT_DIR" >"$BOOTSTRAP_MOUNT_DIR"/etc/fstab

for path in /etc/systemd/{network,networkd.conf.d}; do
    rsync -va "$path"/ "${BOOTSTRAP_MOUNT_DIR%%/}$path"/
done

if [[ -d $BOOTSTRAP_CONFIG_DIR/files ]]; then
    rsync -va --no-{owner,group} "$BOOTSTRAP_CONFIG_DIR"/files/ "$BOOTSTRAP_MOUNT_DIR"/
fi

if [[ -v BOOTSTRAP_HOSTNAME ]]; then
    printf "%s\n" "$BOOTSTRAP_HOSTNAME" >"$BOOTSTRAP_MOUNT_DIR"/etc/hostname
fi

if [[ -v BOOTSTRAP_LANG ]]; then
    printf "LANG=%s\n" "$BOOTSTRAP_LANG" >"$BOOTSTRAP_MOUNT_DIR"/etc/locale.conf
    sed -i "/^#$BOOTSTRAP_LANG/s/#//" "$BOOTSTRAP_MOUNT_DIR"/etc/locale.gen
    arch-chroot "$BOOTSTRAP_MOUNT_DIR" locale-gen
fi

printf "KEYMAP=%q\n" "$BOOTSTRAP_KEYMAP" >"$BOOTSTRAP_MOUNT_DIR"/etc/vconsole.conf

arch-chroot "$BOOTSTRAP_MOUNT_DIR" ln -vsfn /usr/share/zoneinfo/"$BOOTSTRAP_TIMEZONE" /etc/localtime
arch-chroot "$BOOTSTRAP_MOUNT_DIR" systemctl enable systemd-timesyncd.service
arch-chroot "$BOOTSTRAP_MOUNT_DIR" hwclock --systohc

ln -vsfn /run/systemd/resolve/stub-resolv.conf "$BOOTSTRAP_MOUNT_DIR"/etc/resolv.conf
arch-chroot "$BOOTSTRAP_MOUNT_DIR" systemctl enable systemd-{networkd,resolved}.service

export MIRROR_SORT=$BOOTSTRAP_MIRROR_SORT
export MIRROR_LATEST=$BOOTSTRAP_MIRROR_LATEST
export MIRROR_COUNTRY=$BOOTSTRAP_MIRROR_COUNTRY
template-install /etc/xdg/reflector/reflector.conf
arch-chroot "$BOOTSTRAP_MOUNT_DIR" systemctl enable reflector.{service,timer}

if [[ -v BOOTSTRAP_USE_TRIM ]]; then
    sed -E -i '/^[[:space:]]*#?[[:space:]]*issue_discards\b/ { s/#[[:space:]]*//; s/0/1/; }' "$BOOTSTRAP_MOUNT_DIR"/etc/lvm/lvm.conf
    arch-chroot "$BOOTSTRAP_MOUNT_DIR" systemctl enable fstrim.timer
fi

if [[ -v BOOTSTRAP_USE_WIRELESS ]]; then
    rsync -va {,"$BOOTSTRAP_MOUNT_DIR"}/var/lib/iwd/
    arch-chroot "$BOOTSTRAP_MOUNT_DIR" systemctl enable iwd.service
fi

arch-chroot "$BOOTSTRAP_MOUNT_DIR" groupadd -f "$BOOTSTRAP_ADMIN_GROUP"
export ADMIN_GROUP=$BOOTSTRAP_ADMIN_GROUP
if [[ -v BOOTSTRAP_ADMIN_GROUP_NOPASSWD ]]; then
    template-install /etc/sudoers.d/49-admin{-nopasswd,}
    template-install /etc/polkit-1/rules.d/49-admin{-nopasswd,}.rules
else
    template-install /etc/sudoers.d/49-admin
fi

arch-chroot "$BOOTSTRAP_MOUNT_DIR" useradd --create-home --groups users,"$BOOTSTRAP_ADMIN_GROUP" "$BOOTSTRAP_ADMIN_LOGIN"
printf "%s:%s" "$BOOTSTRAP_ADMIN_LOGIN" "$BOOTSTRAP_ADMIN_PASSWORD" | chpasswd -R "$BOOTSTRAP_MOUNT_DIR"
arch-chroot "$BOOTSTRAP_MOUNT_DIR" passwd --lock root

if [[ -v BOOTSTRAP_PARALLEL_DOWNLOADS ]]; then
    pacman-config-parallel-downloads "$BOOTSTRAP_MOUNT_DIR"/etc/pacman.conf "$BOOTSTRAP_PARALLEL_DOWNLOADS"
fi

arch-chroot "$BOOTSTRAP_MOUNT_DIR" systemctl enable sshd.service
