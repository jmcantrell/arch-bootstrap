#!/usr/bin/env bash

set -euo pipefail

genfstab -t UUID "$BOOTSTRAP_MOUNT" >"$BOOTSTRAP_MOUNT"/etc/fstab

for path in /etc/systemd/{network,networkd.conf.d}; do
    rsync -va "$path"/ "${BOOTSTRAP_MOUNT%%/}$path"/
done

if [[ -d $BOOTSTRAP_CONFIG/files ]]; then
    rsync -va --no-{owner,group} "$BOOTSTRAP_CONFIG"/files/ "$BOOTSTRAP_MOUNT"/
fi

if [[ -v BOOTSTRAP_HOSTNAME ]]; then
    printf "%s\n" "$BOOTSTRAP_HOSTNAME" >"$BOOTSTRAP_MOUNT"/etc/hostname
fi

if [[ -v BOOTSTRAP_LANG ]]; then
    printf "LANG=%s\n" "$BOOTSTRAP_LANG" >"$BOOTSTRAP_MOUNT"/etc/locale.conf
    sed -i "/^#$BOOTSTRAP_LANG/s/#//" "$BOOTSTRAP_MOUNT"/etc/locale.gen
    arch-chroot "$BOOTSTRAP_MOUNT" locale-gen
fi

{
    printf "KEYMAP=%s\n" "${BOOTSTRAP_KEYMAP@Q}"
    if [[ -v BOOTSTRAP_FONT ]]; then
        printf "FONT=%s\n" "${BOOTSTRAP_FONT@Q}"
    fi
} >"$BOOTSTRAP_MOUNT"/etc/vconsole.conf

arch-chroot "$BOOTSTRAP_MOUNT" ln -vsfn /usr/share/zoneinfo/"$BOOTSTRAP_TIMEZONE" /etc/localtime
arch-chroot "$BOOTSTRAP_MOUNT" systemctl enable systemd-timesyncd.service
arch-chroot "$BOOTSTRAP_MOUNT" hwclock --systohc

ln -vsfn /run/systemd/resolve/stub-resolv.conf "$BOOTSTRAP_MOUNT"/etc/resolv.conf
arch-chroot "$BOOTSTRAP_MOUNT" systemctl enable systemd-{networkd,resolved}.service

export MIRROR_COUNTRY=$BOOTSTRAP_MIRROR_COUNTRY
template-install /etc/xdg/reflector/reflector.conf
arch-chroot "$BOOTSTRAP_MOUNT" systemctl enable reflector.{service,timer}

if [[ -v BOOTSTRAP_USE_TRIM ]]; then
    sed -E -i '/^[[:space:]]*#?[[:space:]]*issue_discards\b/ { s/#[[:space:]]*//; s/0/1/; }' "$BOOTSTRAP_MOUNT"/etc/lvm/lvm.conf
    arch-chroot "$BOOTSTRAP_MOUNT" systemctl enable fstrim.timer
fi

if [[ -v BOOTSTRAP_USE_WIRELESS ]]; then
    rsync -va {,"$BOOTSTRAP_MOUNT"}/var/lib/iwd/
    arch-chroot "$BOOTSTRAP_MOUNT" systemctl enable iwd.service
fi

arch-chroot "$BOOTSTRAP_MOUNT" groupadd -f "$BOOTSTRAP_ADMIN_GROUP"
export ADMIN_GROUP=$BOOTSTRAP_ADMIN_GROUP
if [[ -v BOOTSTRAP_ADMIN_GROUP_NOPASSWD ]]; then
    template-install /etc/sudoers.d/49-admin-nopasswd
    template-install /etc/polkit-1/rules.d/49-admin-nopasswd.rules
else
    template-install /etc/sudoers.d/49-admin
fi

arch-chroot "$BOOTSTRAP_MOUNT" useradd \
    --create-home --groups users,"$BOOTSTRAP_ADMIN_GROUP" \
    "$BOOTSTRAP_ADMIN_LOGIN"
printf "%s:%s" "$BOOTSTRAP_ADMIN_LOGIN" "$BOOTSTRAP_ADMIN_PASSWORD" | chpasswd -R "$BOOTSTRAP_MOUNT"
arch-chroot "$BOOTSTRAP_MOUNT" passwd --lock root

if [[ -v BOOTSTRAP_PARALLEL_DOWNLOADS ]]; then
    pacman-config-parallel-downloads "$BOOTSTRAP_MOUNT"/etc/pacman.conf "$BOOTSTRAP_PARALLEL_DOWNLOADS"
fi

arch-chroot "$BOOTSTRAP_MOUNT" systemctl enable sshd.service

script=$BOOTSTRAP_CONFIG/install
if [[ -f $script && -x $script ]]; then
    cp "$script" "$BOOTSTRAP_MOUNT"/script
    arch-chroot "$BOOTSTRAP_MOUNT" /script
    rm "$BOOTSTRAP_MOUNT"/script
fi
