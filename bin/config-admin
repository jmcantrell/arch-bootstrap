#!/usr/bin/env bash

set -euo pipefail

install-template /etc/sudoers.d/49-admin

chroot-target groupadd -f "$BOOTSTRAP_ADMIN_GROUP"
chroot-target useradd -m -G users,"$BOOTSTRAP_ADMIN_GROUP" "$BOOTSTRAP_ADMIN_LOGIN"

if [[ -f ~/.ssh/authorized_keys ]]; then
    ssh_dir=/home/$BOOTSTRAP_ADMIN_LOGIN/.ssh
    rsync -va ~/.ssh/authorized_keys "$BOOTSTRAP_TARGET_MOUNT_DIR"/"${ssh_dir#/}"/
    chroot-target chown -vR "$BOOTSTRAP_ADMIN_LOGIN:$BOOTSTRAP_ADMIN_LOGIN" "$ssh_dir"
fi

chroot-target passwd --lock root
chroot-target passwd "$BOOTSTRAP_ADMIN_LOGIN"
