#!/usr/bin/env bash

set -euo pipefail

arch-chroot "$BOOTSTRAP_TARGET_MOUNT_DIR" groupadd -f "$BOOTSTRAP_ADMIN_GROUP"

if ((BOOTSTRAP_ADMIN_GROUP_NOPASSWD)); then
    install-template /etc/sudoers.d/49-admin{-nopasswd,}
    install-template /etc/polkit-1/rules.d/49-admin{-nopasswd,}.rules
else
    install-template /etc/sudoers.d/49-admin
fi

arch-chroot "$BOOTSTRAP_TARGET_MOUNT_DIR" useradd --create-home --groups users,"$BOOTSTRAP_ADMIN_GROUP" "$BOOTSTRAP_ADMIN_LOGIN"

chpasswd -R "$BOOTSTRAP_TARGET_MOUNT_DIR" <<<"$BOOTSTRAP_ADMIN_LOGIN:$BOOTSTRAP_ADMIN_PASSWORD"

if [[ -f ~/.ssh/authorized_keys ]]; then
    rsync -va ~/.ssh/authorized_keys "$BOOTSTRAP_TARGET_MOUNT_DIR"/home/"$BOOTSTRAP_ADMIN_LOGIN"/.ssh/
    arch-chroot "$BOOTSTRAP_TARGET_MOUNT_DIR" chown --verbose --recursive "$BOOTSTRAP_ADMIN_LOGIN:$BOOTSTRAP_ADMIN_LOGIN" /home/"$BOOTSTRAP_ADMIN_LOGIN"/.ssh
fi

arch-chroot "$BOOTSTRAP_TARGET_MOUNT_DIR" passwd --lock root
