#!/usr/bin/env bash

set -euo pipefail

arch-chroot "$BOOTSTRAP_TARGET_MOUNT_DIR" \
    groupadd -f "$BOOTSTRAP_ADMIN_GROUP"

install-template /etc/sudoers.d/49-admin

arch-chroot "$BOOTSTRAP_TARGET_MOUNT_DIR" \
    useradd -m -G users,"$BOOTSTRAP_ADMIN_GROUP" "$BOOTSTRAP_ADMIN_LOGIN"

if [[ -f ~/.ssh/authorized_keys ]]; then
    ssh_dir=/home/$BOOTSTRAP_ADMIN_LOGIN/.ssh
    rsync -va ~/.ssh/authorized_keys \
        "$BOOTSTRAP_TARGET_MOUNT_DIR"/"${ssh_dir#/}"/
    arch-chroot "$BOOTSTRAP_TARGET_MOUNT_DIR" \
        chown -vR "$BOOTSTRAP_ADMIN_LOGIN:$BOOTSTRAP_ADMIN_LOGIN" "$ssh_dir"
fi

arch-chroot "$BOOTSTRAP_TARGET_MOUNT_DIR" \
    passwd --lock root

arch-chroot "$BOOTSTRAP_TARGET_MOUNT_DIR" \
    passwd "$BOOTSTRAP_ADMIN_LOGIN"
