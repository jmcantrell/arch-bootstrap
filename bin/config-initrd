#!/usr/bin/env bash

set -euo pipefail

binaries=(/usr/bin/btrfs)
modules=()
hooks=(base udev autodetect modconf kms)
files=()

if [[ -v BOOTSTRAP_GPU_MODULES && -n $BOOTSTRAP_GPU_MODULES ]]; then
    readarray -t modules <<<"$BOOTSTRAP_GPU_MODULES"
fi

if ((BOOTSTRAP_USE_LUKS)); then
    hooks+=(keyboard keymap consolefont)
    files+=("$BOOTSTRAP_LUKS_KEY_FILE")
fi

hooks+=(block)

if ((BOOTSTRAP_USE_LUKS)); then
    hooks+=(encrypt)
fi

hooks+=(lvm2)

if ((BOOTSTRAP_USE_SWAP)); then
    hooks+=(resume)
fi

hooks+=(filesystems btrfs fsck)

export BOOTSTRAP_INITRD_BINARIES=${binaries[*]}
export BOOTSTRAP_INITRD_MODULES=${modules[*]}
export BOOTSTRAP_INITRD_HOOKS=${hooks[*]}
export BOOTSTRAP_INITRD_FILES=${files[*]}

install-template /etc/mkinitcpio.conf
