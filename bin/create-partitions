#!/usr/bin/env bash

set -euo pipefail

fields=(size type name)
parts=(boot ${BOOTSTRAP_PART_SWAP_SIZE:+swap} sys)

format=
for field in "${fields[@]}"; do
    format+="$field=%s, "
done
format=${format%, }

values=()
for part in "${parts[@]}"; do
    for field in "${fields[@]}"; do
        variable=BOOTSTRAP_PART_${part@U}_${field@U}
        values+=("${!variable}")
    done
done

printf -v lines "$format\n" "${values[@]}"

printf "label: gpt\n%s\n" "$lines" | sfdisk "$BOOTSTRAP_TARGET_DEVICE"
