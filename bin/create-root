#!/usr/bin/env bash

set -euo pipefail

mkfs.btrfs --verbose --label "$BOOTSTRAP_FS_ROOT_LABEL" "$BOOTSTRAP_ROOT_DEVICE"

mkdir -p "$BOOTSTRAP_TARGET_MOUNT_DIR"

mount --verbose "$BOOTSTRAP_ROOT_DEVICE" "$BOOTSTRAP_TARGET_MOUNT_DIR"

while read -r name _; do
    btrfs subvolume create "$BOOTSTRAP_TARGET_MOUNT_DIR/$name"
done < <(print-btrfs-subvolumes)

umount --verbose "$BOOTSTRAP_TARGET_MOUNT_DIR"
