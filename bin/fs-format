#!/usr/bin/env bash

set -eu

if [[ -v INSTALL_EFI_DIR ]]; then
    mkfs.fat -F32 "$INSTALL_BOOT_DEVICE"
fi

mkfs.btrfs --label root "$INSTALL_ROOT_DEVICE"

mkdir -p "$INSTALL_DIR"

mount "$INSTALL_ROOT_DEVICE" "$INSTALL_DIR"

btrfs subvolume create "$INSTALL_DIR"/@

if [[ -f $CONFIG_DIR/subvolumes ]]; then
    while read -r name _; do
        btrfs subvolume create "$INSTALL_DIR/@$name"
    done <"$CONFIG_DIR"/subvolumes
fi

umount "$INSTALL_DIR"
