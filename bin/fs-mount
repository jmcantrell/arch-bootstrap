#!/usr/bin/env bash

set -euo pipefail

mkdir -p "$INSTALL_DIR"

while read -r subvol dir; do
    mnt_dir=$INSTALL_DIR/${dir#/}
    mkdir -p "$mnt_dir"
    mount -o autodefrag,compress=zstd,subvol="$subvol" "$INSTALL_ROOT_DEVICE" "$mnt_dir"
done <"$BOOTSTRAP_DIR"/config/subvolumes

if ((${INSTALL_EFI:-0})); then
    efi_dir=$INSTALL_DIR/boot/efi
    mkdir -p "$efi_dir"
    mount "$INSTALL_BOOT_DEVICE" "$efi_dir"
fi
