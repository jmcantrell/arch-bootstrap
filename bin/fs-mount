#!/usr/bin/env bash

set -euo pipefail

while read -r name path; do
    subvolume_mount=$BOOTSTRAP_MOUNT_DIR/${path#/}
    mkdir -p "$subvolume_mount"
    mount --verbose --options \
        "${BOOTSTRAP_FS_ROOT_OPTIONS:+$BOOTSTRAP_FS_ROOT_OPTIONS,}subvol=$name" \
        "$BOOTSTRAP_ROOT_DEVICE" "$subvolume_mount"
done < <(subvolumes)

if [[ $BOOTSTRAP_BOOT_FIRMWARE == uefi ]]; then
    uefi_mount=$BOOTSTRAP_MOUNT_DIR/${BOOTSTRAP_UEFI_MOUNT_DIR#/}
    mkdir -p "$uefi_mount"
    mount --verbose "$BOOTSTRAP_BOOT_DEVICE" "$uefi_mount"
fi
