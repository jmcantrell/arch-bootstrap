#!/usr/bin/env bash

set -euo pipefail

grub_preload_modules=(part_gpt part_msdos lvm)
grub_cmdline_linux=(root="${INSTALL_ROOT_DEVICE}" resume="$INSTALL_SWAP_DEVICE")
grub_cmdline_linux_default=(loglevel=3 quiet)

if [[ -v INSTALL_CONSOLE_BLANK ]]; then
    grub_cmdline_linux_default+=(consoleblank="$INSTALL_CONSOLE_BLANK")
fi

if [[ -v INSTALL_LUKS_DEVICE ]]; then
    export GRUB_ENABLE_CRYPTODISK=y
    grub_preload_modules+=(cryptodisk luks)
    grub_cmdline_linux+=(cryptdevice=PARTUUID="$(blkid -s PARTUUID -o value "$INSTALL_LUKS_DEVICE"):$INSTALL_LUKS_NAME")
else
    export GRUB_ENABLE_CRYPTODISK=n
fi

export GRUB_PRELOAD_MODULES=${grub_preload_modules[*]}
export GRUB_CMDLINE_LINUX=${grub_cmdline_linux[*]}
export GRUB_CMDLINE_LINUX_DEFAULT=${grub_cmdline_linux_default[*]}
template-install ./templates/etc/default/grub

arch-chroot /mnt grub-install "$INSTALL_DEVICE" --recheck
arch-chroot /mnt grub-mkconfig -o /boot/grub/grub.cfg
