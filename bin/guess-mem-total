#!/usr/bin/env bash

# Get a human-readable size for the total amount of memory.
# This is necessary because /proc/meminfo under reports the total memory.
# It's assumed that physical memory is a standard size (i.e. power of two).

set -eu

units=(K M G T P E)

mem_total_kb=$(grep "^MemTotal" /proc/meminfo | awk '{print $2}')
mem_total=$mem_total_kb
unit_index=0

# Find the largest unit such that the floor value is non-zero.
# For example, floor(0.1G) == 0, so report size in M (megabytes).
for ((i = 0; i < ${#units[@]}; i++)); do
    value=$((mem_total_kb / (1024 ** i)))
    if ((value == 0)); then
        break
    fi
    mem_total=$value
    unit_index=$i
done

# Round the value to the next power of two.
# For example, round(15.1G) == 16G
real_total=1
while true; do
    if ((real_total >= mem_total)); then
        break
    fi
    real_total=$((real_total << 1))
done

printf "%s%s" "$real_total" "${units[unit_index]}"
