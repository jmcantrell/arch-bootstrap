#!/usr/bin/env bash

set -euo pipefail

binaries=(/usr/bin/btrfs)
modules=()
files=()
hooks=(base udev autodetect)

if [[ ${INSTALL_CPU_VENDOR:-unknown} == intel ]]; then
    modules+=(crc32c-intel intel_agp i915)
fi

if [[ -v INSTALL_LUKS_DEVICE ]]; then
    hooks+=(keyboard keymap consolefont)
    keyfile_name=crypto_keyfile.bin
    cp -a "$INSTALL_LUKS_KEYFILE" "$INSTALL_DIR/$keyfile_name"
    files+=("/$keyfile_name")
fi

hooks+=(modconf block)

if [[ -v INSTALL_LUKS_DEVICE ]]; then
    hooks+=(encrypt)
fi

hooks+=(resume lvm2 filesystems btrfs)

if [[ ! -v INSTALL_LUKS_DEVICE ]]; then
    hooks+=(keyboard)
fi

hooks+=(fsck)

export INITRD_BINARIES=${binaries[*]}
export INITRD_MODULES=${modules[*]}
export INITRD_HOOKS=${hooks[*]}
export INITRD_FILES=${files[*]}
template-install /etc/mkinitcpio.conf

arch-chroot "$INSTALL_DIR" mkinitcpio --allpresets
