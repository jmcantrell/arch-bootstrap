#!/usr/bin/env bash

set -euo pipefail

unset config_file

if [[ -v BOOTSTRAP_PACKAGE_REPO_SERVER ]]; then
    config_file=/tmp/pacman.conf
    cp /etc/pacman.conf "$config_file"
    set-package-repo "$config_file" \
        "$BOOTSTRAP_PACKAGE_REPO_NAME" \
        "$BOOTSTRAP_PACKAGE_REPO_SERVER"
fi

pacman-key --init
pacman-key --populate

readarray -t packages < <(print-packages)

pacstrap ${config_file:+-C "$config_file"} \
    "$BOOTSTRAP_TARGET_MOUNT_DIR" "${packages[@]}"
