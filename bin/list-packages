#!/usr/bin/env bash

set -euo pipefail

packages=(
    base
    btrfs-progs
    lvm2
    openssh
    reflector
    sudo
)

case $INSTALL_BOOT_FIRMWARE in
bios) packages+=(grub-bios) ;;
uefi) packages+=(grub efibootmgr) ;;
esac

if ! systemd-detect-virt -q --container; then
    packages+=(linux)
fi

if [[ -v INSTALL_NET_USE_WIRELESS ]]; then
    packages+=(iwd)
fi

if [[ -v INSTALL_CPU_VENDOR ]]; then
    packages+=("$INSTALL_CPU_VENDOR"-ucode)
fi

if [[ -v INSTALL_SUDOER_SHELL ]]; then
    packages+=("${INSTALL_SUDOER_SHELL##*/}")
fi

sort -u <(list "$INSTALL_CONFIG"/packages) <(printf "%s\n" "${packages[@]}")
