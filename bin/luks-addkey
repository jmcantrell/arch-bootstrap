#!/usr/bin/env bash

set -euo pipefail

key_slot=1

# Ensure the reserved key slot is available, i.e., kill it if occupied.
if cryptsetup luksDump "$BOOTSTRAP_LUKS_DEVICE" | grep -q "^Key Slot $key_slot: ENABLED"; then
    cryptsetup luksKillSlot "$BOOTSTRAP_LUKS_DEVICE" "$key_slot" <<<"$BOOTSTRAP_LUKS_PASSPHRASE"
fi

cryptsetup luksAddKey --new-key-slot "$key_slot" "$BOOTSTRAP_LUKS_DEVICE" "$(luks-createkey)" <<<"$BOOTSTRAP_LUKS_PASSPHRASE"
