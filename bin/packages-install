#!/usr/bin/env bash

set -euo pipefail

pacman-key --init
pacman-key --populate
pacman --sync --refresh --needed --noconfirm archlinux-keyring

if [[ -v BOOTSTRAP_PARALLEL_DOWNLOADS ]]; then
    pacman-config-parallel-downloads /etc/pacman.conf "$BOOTSTRAP_PARALLEL_DOWNLOADS"
fi

readarray -t packages < <(packages)

pacstrap ${BOOTSTRAP_PACKAGE_CACHE:+-c} "$BOOTSTRAP_MOUNT" "${packages[@]}"
