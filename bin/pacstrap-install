#!/usr/bin/env bash

set -euo pipefail

readarray -t packages <"$BOOTSTRAP_DIR"/config/packages

if [[ -v INSTALL_CPU_VENDOR ]]; then
    packages+=("$INSTALL_CPU_VENDOR"-ucode)
fi

if ((${INSTALL_EFI:-0})); then
    packages+=(grub efibootmgr)
else
    packages+=(grub-bios)
fi

if [[ $INSTALL_VIRTUAL == oracle ]]; then
    packages+=(virtualbox-guest-utils-nox)
fi

# Enable parallel package downloads.
sed -i '/^#\?ParallelDownloads\b/s/#//' /etc/pacman.conf

pacstrap /mnt "${packages[@]}"
