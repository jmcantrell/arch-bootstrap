#!/usr/bin/env bash

set -eu

readarray -t packages <./config/packages

if [[ -v INSTALL_CPU_VENDOR ]]; then
    packages+=("$INSTALL_CPU_VENDOR"-ucode)
fi

if [[ -v INSTALL_EFI_DIR ]]; then
    packages+=(grub efibootmgr)
else
    packages+=(grub-bios)
fi

if [[ $INSTALL_VM_TYPE == oracle ]]; then
    packages+=(virtualbox-guest-utils-nox)
fi

# Enable parallel package downloads.
sed -i '/^#\?ParallelDownloads\b/s/#//' /etc/pacman.conf

if [[ -v INSTALL_PACMAN_CACHE ]]; then
    pacman_cache=$INSTALL_DIR/var/cache/pacman/pkg
    mkdir -p "$pacman_cache"
    rsync -rv "$INSTALL_PACMAN_CACHE/" "$pacman_cache"
fi

pacstrap "$INSTALL_DIR" "${packages[@]}"
