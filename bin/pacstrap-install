#!/usr/bin/env bash

set -eu

readarray -t pkgs <"$CONFIG_DIR"/pkgs

if [[ -v INSTALL_CPU_VENDOR ]]; then
    pkgs+=("$INSTALL_CPU_VENDOR"-ucode)
fi

if [[ -v INSTALL_EFI_DIR ]]; then
    pkgs+=(grub efibootmgr)
else
    pkgs+=(grub-bios)
fi

# Enable parallel package downloads.
sed -i '/^#\?ParallelDownloads\b/s/#//' /etc/pacman.conf

if [[ -v INSTALL_PACMAN_CACHE ]]; then
    pacman_cache=$INSTALL_DIR/var/cache/pacman/pkg
    mkdir -p "$pacman_cache"
    rsync -rv "$INSTALL_PACMAN_CACHE/" "$pacman_cache"
fi

pacstrap "$INSTALL_DIR" "${pkgs[@]}"
