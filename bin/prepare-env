#!/usr/bin/env bash

# Prompt the user for all necessary install details.

set -euo pipefail

INSTALL_DEVICE=$(choose-disk "installation disk")
export INSTALL_DEVICE

INSTALL_SWAP_SIZE=$(input-required "swap size" "$(guess-swapsize)")
export INSTALL_SWAP_SIZE

export INSTALL_GRUB_DEVICE=${INSTALL_DEVICE}1
export INSTALL_OS_DEVICE=${INSTALL_DEVICE}2

export INSTALL_LVM_DEVICE=$INSTALL_OS_DEVICE
export INSTALL_ROOT_DEVICE=/dev/mapper/vg-root
export INSTALL_SWAP_DEVICE=/dev/mapper/vg-swap

if ask "Enable luks encryption?"; then
    export INSTALL_LUKS=1
    export INSTALL_LUKS_DEVICE=$INSTALL_OS_DEVICE
    export INSTALL_LUKS_NAME=lvm
    export INSTALL_LUKS_KEYFILE=$PWD/keyfile-$INSTALL_LUKS_NAME.bin

    INSTALL_LUKS_PASSPHRASE=$(input-secret "encryption passphrase")
    export INSTALL_LUKS_PASSPHRASE

    export INSTALL_LVM_DEVICE=/dev/mapper/lvm
fi

INSTALL_LANG=$(input-required locale en_US.UTF-8)
export INSTALL_LANG

INSTALL_KEYMAP=$(input-required keymap us)
export INSTALL_KEYMAP

INSTALL_TIMEZONE=$(tzselect)
export INSTALL_TIMEZONE

INSTALL_HOSTNAME=$(input-required "host name")
export INSTALL_HOSTNAME

INSTALL_SUDOER_USERNAME=$(input-required "sudoer username")
export INSTALL_SUDOER_USERNAME

INSTALL_SUDOER_PASSWORD=$(input-secret "sudoer password")
export INSTALL_SUDOER_PASSWORD

if ask "Enable password-less sudo?"; then
    export INSTALL_SUDOER_NOPASSWD=1
fi
