#!/usr/bin/env bash

set -euo pipefail

config_file=${1:?missing config file}
repo_dir=${2:?missing repo directory}

db_file=$(find "$repo_dir" -type f -name "*.db.tar.*")

if [[ -z $db_file ]]; then
    printf "%s: directory is not a package repository: %q\n" "$0" "$repo_dir" >&2
    exit 2
fi

sed -Ei '/^\[(core|core-testing|extra|extra-testing|multilib|multilib-testing)\]$/,/^$/s/^./#&/' "$config_file"

db_name=${db_file##*/}
db_name=${db_name%%.db.*}

if grep -qxF "[$db_name]" "$config_file"; then
    printf "%s: repository already exists: %s\n" "$0" "$db_name" >&2
    exit 2
fi

cat >>"$config_file" <<EOF
[$db_name]
SigLevel = Optional
Server = file://$(realpath "$repo_dir")
EOF
