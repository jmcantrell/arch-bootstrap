#!/usr/bin/env bash

set -euo pipefail

create-partitions

if [[ -v BOOTSTRAP_USE_LUKS ]]; then
    create-luks
    open-luks
fi

create-lvm

if [[ -v BOOTSTRAP_USE_SWAP ]]; then
    create-lvm-swap
    open-lvm-swap
    create-swap
    open-swap
fi

create-lvm-root
open-lvm-root
create-root
open-root

if [[ $BOOTSTRAP_BOOT_FIRMWARE == uefi ]]; then
    create-uefi
    open-uefi
fi

if [[ -v BOOTSTRAP_PACKAGE_REPO_DIR ]]; then
    set-offline-package-repo "$BOOTSTRAP_PACKAGE_REPO_DIR"
fi

install-packages

if [[ -v BOOTSTRAP_USE_TRIM ]]; then
    config-trim
fi

config-network

if [[ -v BOOTSTRAP_USE_WIRELESS ]]; then
    config-wireless
fi

config-hostname
config-timezone
config-ntp
config-lang
config-keymap
config-mirrors
config-admin
config-ssh
config-boot
config-initrd

if [[ -v BOOTSTRAP_USE_LUKS ]]; then
    install-luks-keyfile
fi

install-locale
install-fstab
install-initrd
install-boot
