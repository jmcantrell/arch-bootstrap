#!/usr/bin/env bash

set -euo pipefail

self_name=${0##*/}

usage="Test installation in a virtual machine.

Usage:
    $self_name -h|--help
    $self_name [OPTIONS] ISO_FILE

Options:
    -p PORT    forward host PORT to port 22 on the guest
               (tcp only, default: same as ./scripts/vm)

    -c ID    set guest vsock client ID
             (default: same as ./scripts/vm)

    -e    edit configuration before building cloud-init image

    -y    proceed with the installation
          (specify twice to also reboot into the new system)

Arguments:
    ISO_FILE     installation media ISO file
"

if (($# > 0)); then
    if [[ $1 == -h || $1 == --help ]]; then
        printf "%s\n" "$usage"
        exit
    fi
fi

vm_opts=()
mkvm_opts=()

while getopts "p:c:ey" opt; do
    case $opt in
    p | c) vm_opts+=(-"$opt" "$OPTARG") ;;
    e | y) mkvm_opts+=(-"$opt") ;;
    *) exit 2 ;;
    esac
done
shift $((OPTIND - 1))

media_file=${1:?missing media file}

temp_dir=$(mktemp -d -t "$self_name-$$".XXXXXXXXXX)
trap 'rm -rf "$temp_dir"' EXIT

disk_file=$temp_dir/disk.cow

./scripts/mkvm "${vm_opts[@]}" "${mkvm_opts[@]}" "$media_file" "$disk_file"

./scripts/vm "${vm_opts[@]}" "$disk_file"
